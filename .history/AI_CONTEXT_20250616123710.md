# AI CONTEXT - LiteCMMS v2.0

> **INSTRUKCJA DLA AI**: Ten plik zawiera pełny kontekst projektu. Przeczytaj go na początku każdej nowej sesji.

## 🎯 PODSTAWOWE INFORMACJE

### Projekt

- **Nazwa**: LiteCMMS v2.0
- **Typ**: System CMMS (Computerized Maintenance Management System)
- **Cel**: Średnie przedsiębiorstwa (do 50 użytkowników)
- **Status**: Faza 6 ukończona - infrastruktura gotowa

### Język komunikacji

- **ZAWSZE odpowiadaj po polsku** - główne wymaganie użytkownika

## 🛠️ STACK TECHNICZNY

### Frontend

- Next.js 15 z App Router, TypeScript, Tailwind CSS
- Wielojęzyczność: PL (domyślny), EN, DE
- Port: localhost:3000

### Backend

- Fastify, TypeScript, Prisma ORM
- CORS skonfigurowany, nodemon auto-restart
- Port: localhost:3001

### Baza Danych

- PostgreSQL 17
- Prisma z pełną strukturą CMMS (493 linie schema)
- Port: localhost:5432

## ✅ AKTUALNY STAN SYSTEMU

### System w pełni działający

1. **Frontend Next.js**: Localhost:3000, wielojęzyczność PL/EN/DE
2. **Backend Fastify**: Localhost:3001, endpointy `/health`, `/api/status`, `/api/system-status`
3. **PostgreSQL 17**: Port 5432, baza `litecmms`, hasło: `8C5c3Aab5`
4. **Prisma ORM**: Migracja `20250615205446_init`, wszystkie tabele CMMS
5. **DATABASE_URL**: ✅ Prawidłowo ładowana z `database.env` (problem BOM rozwiązany)
6. **System Automatyzacji**: Komendy `npm run sys:*` dla zarządzania procesami

### Endpointy

- **Health**: `GET /health`
- **Status API**: `GET /api/status`
- **System Status**: `GET /api/system-status`

## 🔧 KONFIGURACJA

### Pliki kluczowe

- `package.json` - zależności i skrypty
- `prisma/schema.prisma` - schema PostgreSQL
- `server/index.ts` - główny serwer
- `database.env` - konfiguracja DATABASE_URL

### Skrypty npm (ZALECANE)

```bash
npm run sys:start    # Uruchom system (backend + frontend)
npm run sys:stop     # Zatrzymaj wszystkie procesy
npm run sys:restart  # Restart systemu
npm run sys:status   # Status wszystkich komponentów
```

### Backup skrypty (jeśli sys:* nie działają)

```bash
npm run dev:server   # Backend w obecnym terminalu
npm run dev          # Frontend w osobnym terminalu
npm run stop-all     # Zatrzymaj wszystkie procesy
```

## 📝 HISTORIA ROZWOJU (KLUCZOWE FAZY)

### Faza 1-4: Infrastruktura podstawowa (UKOŃCZONA ✅)

- Serwer Fastify + CORS
- PostgreSQL 17 + Prisma
- Frontend Next.js + wielojęzyczność
- Komunikacja Frontend-Backend-Database

### Faza 5: System Automatyzacji (UKOŃCZONA ✅)

- Skrypty PowerShell do zarządzania procesami
- 8 komend npm (`sys:*`)
- Automatyczne rozwiązywanie konfliktów portów

### Faza 6: Naprawa DATABASE_URL (UKOŃCZONA ✅)

- **Problem**: BOM (Byte Order Mark) w `database.env`
- **Rozwiązanie**: Usunięto BOM, usunięto hardkodowany fallback
- **Rezultat**: `dotenv.config()` prawidłowo ładuje DATABASE_URL

### 🔍 Odkrycie gotowego systemu autoryzacji

- `server/routes/auth.ts` - endpointy login/register/logout/refresh
- `server/middleware/auth.ts` - JWT middleware + kontrola ról
- 5 poziomów ról: ADMINISTRATOR, MANAGER, OPERATOR, TECHNICIAN, REPORTS
- **Zależności zainstalowane**: `bcryptjs`, `jsonwebtoken`, `@fastify/jwt`, `zod`
- **Status**: Napisane ale nie zintegrowane z głównym serwerem

## 🚀 NASTĘPNE KROKI

### Priorytet 1: Integracja autoryzacji

1. ✅ Modele użytkowników - GOTOWE
2. ✅ Endpointy auth - NAPISANE
3. ✅ JWT middleware - NAPISANE
4. 🔄 **DO ZROBIENIA - BŁĄD NA EKRANIE**: 
   - **Problem**: `Property 'prisma' does not exist on type 'FastifyInstance'`
   - **Przyczyna**: Prisma nie jest zarejestrowana jako plugin w Fastify
   - **Rozwiązanie**: Zintegrować Prisma Client z głównym serwerem
   - **Kroki**: 
     1. Dodać `fastify.decorate('prisma', prisma)` w `server/index.ts`
     2. Zarejestrować JWT plugin (`@fastify/jwt`)
     3. Zarejestrować bcrypt plugin
     4. Zarejestrować route'y autoryzacji
     5. Przetestować endpointy `/api/auth/register` i `/api/auth/login`

### Priorytet 2: Funkcjonalności CMMS

1. Zarządzanie maszynami
2. System zgłoszeń awarii
3. Zlecenia pracy (Work Orders)
4. Dashboard i raporty

## 🎯 METODOLOGIA PRACY

### Wymagania użytkownika

1. **Małe kroki z testami** - każda zmiana testowana
2. **Prawdziwe rozwiązania** - nie mock dane
3. **PostgreSQL** - definitywnie, nie SQLite
4. **Bezpieczeństwo** - wszystko bezpieczne
5. **Cofanie zmian** - powrót do działającego stanu

### Zasady kodowania

1. **Wielojęzyczność**: Wszystkie teksty w `locales/*/common.json`
   - ❌ `<p>Tekst</p>` 
   - ✅ `<p>{t('klucz')}</p>`
2. **Struktura kluczy**: `sekcja.element` dla wszystkich języków (PL/EN/DE)

## 💡 WSKAZÓWKI DLA AI

### Na początku sesji

1. Sprawdź `npm run sys:status`
2. Przeczytaj logi terminala
3. **PRIORYTET**: Napraw błąd Prisma w Fastify (widzisz błędy TypeScript na ekranie)
4. Zintegruj system autoryzacji z głównym serwerem
5. Przetestuj endpointy `/api/auth/*`

### ⚠️ Problemy środowiska

1. **PowerShell**: Błędy PSReadLine - używaj prostych komend
2. **DATABASE_URL**: Używa `database.env` (bez pliku `.env`)
3. **Uprawnienia**: Niektóre operacje wymagają "Run as Administrator"

### ⚠️ PRZED KOŃCEM SESJI - OBOWIĄZKOWE!

**ZAWSZE przed końcem limitu chatu:**

1. **Zaktualizuj AI_CONTEXT.md**:
   - Dodaj nowe osiągnięcia do sekcji "AKTUALNY STAN SYSTEMU"
   - Zaktualizuj "HISTORIA ROZWOJU" z nowymi fazami
   - Zaktualizuj "NASTĘPNE KROKI" 
   - Dodaj nowe rozwiązania do "KLUCZOWE ROZWIĄZANIA"

2. **Zaktualizuj README.md** (jeśli potrzeba):
   - Nowe instrukcje instalacji
   - Zmiany w strukturze projektu  
   - Nowe endpointy/funkcjonalności

3. **Poinformuj użytkownika**:
   - "🔄 **AKTUALIZUJĘ PLIKI KONTEKSTU** przed końcem sesji"
   - Podsumuj co zostało zrobione
   - Wskaż co trzeba kontynuować w następnej sesji

**Przykład komunikatu:**
> 🔄 **AKTUALIZUJĘ PLIKI KONTEKSTU** przed końcem sesji  
> ✅ **Osiągnięcia**: Autoryzacja zintegrowana, endpointy działają  
> ⚠️ **Do kontynuacji**: Frontend logowania  
> 📝 **Pliki zaktualizowane**: AI_CONTEXT.md, README.md

### Czego unikać

- Nie zmieniać działających części
- Nie proponować SQLite
- **NIGDY nie hardkodować tekstów**
- **❌ NIE KOŃCZYĆ SESJI bez aktualizacji kontekstu!**
- **❌ NIE KOŃCZYĆ bez komunikatu podsumowującego!**

## 🔍 DIAGNOSTYKA

### Sprawdzanie

- Frontend: http://localhost:3000
- Backend: http://localhost:3001/api/system-status
- Health: http://localhost:3001/health

### Typowe problemy

- Port zajęty → restart serwera
- CORS errors → sprawdzić konfigurację
- Database → sprawdzić `/api/system-status`

## 📋 KLUCZOWE ROZWIĄZANIA

1. **DATABASE_URL**: ✅ Prawidłowe ładowanie z `database.env` (usunięto BOM)
2. **Konflikt portów**: Automatyczne rozwiązywanie w skryptach
3. **Kodowanie**: Wszystkie skrypty bez polskich znaków
4. **Migracje**: Pierwsza migracja `20250615205446_init` wykonana

## ❌ NIEUDANE PRÓBY - NIE POWTARZAĆ

- **SQLite** - zbyt wiele ograniczeń (brak Json, enum, Decimal)
- **Docker** - problemy z uruchomieniem Docker Desktop
- **Plik `.env`** - nie istnieje, system używa `database.env`

---

**Ostatnia aktualizacja**: Styczeń 2025 - Faza 6 ukończona  
**Wersja kontekstu**: 2.0 - Uporządkowana  
**Status**: Aktualny - DATABASE_URL naprawiona, autoryzacja odkryta, gotowy do integracji 