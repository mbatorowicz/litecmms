# AI CONTEXT - LiteCMMS v2.0

> **INSTRUKCJA DLA AI**: Ten plik zawiera pełny kontekst projektu. Przeczytaj go na początku każdej nowej sesji.

## 🎯 PODSTAWOWE INFORMACJE

### Projekt

- **Nazwa**: LiteCMMS v2.0
- **Typ**: System CMMS (Computerized Maintenance Management System)
- **Cel**: Średnie przedsiębiorstwa (do 50 użytkowników)
- **Status**: W rozwoju - faza podstawowej infrastruktury

### Język komunikacji

- **ZAWSZE odpowiadaj po polsku** - to jest główne wymaganie użytkownika
- Użytkownik mówi po polsku i oczekuje odpowiedzi w tym języku

## 🛠️ STACK TECHNICZNY

### Frontend (DZIAŁA ✅)

- Next.js 15 z App Router
- TypeScript
- Tailwind CSS
- Wielojęzyczność: PL (domyślny), EN, DE
- Port: localhost:3000

### Backend (DZIAŁA ✅)

- Fastify
- TypeScript
- CORS skonfigurowany dla localhost:3000
- Port: localhost:3001
- Nodemon dla auto-restart

### Baza Danych (W TRAKCIE KONFIGURACJI ⚠️)

- **PostgreSQL** (USTALONO - nie SQLite!)
- Prisma ORM
- Schema gotowa (493 linie, pełne modele CMMS)
- Problem: Brak działającego połączenia

## 📊 AKTUALNY STAN SYSTEMU

### ✅ CO DZIAŁA

1. **Frontend Next.js**:
   - Uruchamia się na localhost:3000
   - Wielojęzyczność PL/EN/DE działa
   - Komponenty React działają
   - Komunikacja z backendem działa

2. **Backend Fastify**:
   - Uruchamia się na localhost:3001
   - Endpointy działają:
     - `GET /health` - health check
     - `GET /api/status` - status API
     - `GET /api/system-status` - status systemu
   - CORS skonfigurowany
   - Logi działają poprawnie

3. **Komunikacja Frontend-Backend**:
   - Frontend pobiera dane z `/api/system-status`
   - Status wyświetla się poprawnie:
     - 🟢 API Server: "Połączenie aktywne"
     - 🟡 Baza danych: "Baza danych nie skonfigurowana"

### ✅ CO DZIAŁA - SYSTEM GOTOWY!

1. **Frontend Next.js** - ✅ PEŁNE DZIAŁANIE:
   - Uruchamia się na localhost:3000
   - Wielojęzyczność PL/EN/DE działa
   - Komponenty React działają
   - Komunikacja z backendem działa
   - i18next skonfigurowane poprawnie

2. **Backend Fastify** - ✅ PEŁNE DZIAŁANIE:
   - Uruchamia się na localhost:3001
   - Endpointy działają:
     - `GET /health` - health check
     - `GET /api/status` - status API
     - `GET /api/system-status` - status systemu
   - CORS skonfigurowany
   - Pełne połączenie z bazą danych

3. **PostgreSQL 17** - ✅ PEŁNE DZIAŁANIE:
   - Port 5432 aktywny
   - Hasło: `8C5c3Aab5`
   - Baza `litecmms` utworzona
   - DATABASE_URL: `postgresql://postgres:8C5c3Aab5@localhost:5432/litecmms?schema=public`

4. **Prisma ORM** - ✅ PEŁNE DZIAŁANIE:
   - Migracje wykonane (`20250615205446_init`)
   - Wszystkie tabele CMMS utworzone
   - Prisma Client działający

5. **Komunikacja Frontend-Backend-Database** - ✅ PEŁNY ŁAŃCUCH:
   - Frontend → Backend: OK
   - Backend → Database: OK  
   - System Status: wszystkie komponenty "ok"

6. **System Automatyzacji** - ✅ PEŁNE DZIAŁANIE:
   - `npm run sys:start` - uruchamia system w osobnych oknach
   - `npm run sys:stop` - zatrzymuje wszystkie procesy
   - `npm run sys:status` - pokazuje pełny status
   - `npm run sys:restart` - pełny restart systemu
   - Automatyczne rozwiązywanie konfliktów portów
   - Niezawodne zarządzanie procesami

### ✅ PROBLEMY ROZWIĄZANE

1. **PostgreSQL instalacja** - ✅ ROZWIĄZANE:
   - ✅ Repair Install PostgreSQL 17 wykonany
   - ✅ `postgres.exe` istnieje i działa
   - ✅ Usługa PostgreSQL uruchamia się bez błędów
   - ✅ Port 5432 odpowiada poprawnie

2. **DATABASE_URL konfiguracja** - ✅ CAŁKOWICIE ROZWIĄZANE:
   - ✅ Usunięto BOM (Byte Order Mark) z pliku `database.env`
   - ✅ `dotenv.config()` teraz prawidłowo ładuje DATABASE_URL
   - ✅ Usunięto hardkodowany fallback z `server/index.ts`
   - ✅ System używa wyłącznie konfiguracji z pliku `database.env`
   - ✅ Logi potwierdzają: "✅ DATABASE_URL załadowana z database.env"

3. **Migracje Prisma** - ✅ UKOŃCZONE:
   - ✅ Pierwsza migracja `20250615205446_init` wykonana
   - ✅ Wszystkie tabele CMMS utworzone w bazie

### 🔄 NASTĘPNE KROKI - ROZWÓJ FUNKCJONALNOŚCI

1. **Autoryzacja i użytkownicy**:
   - System logowania
   - 5 poziomów ról użytkowników
   - JWT tokeny

2. **Pierwsze funkcjonalności CMMS**:
   - Zarządzanie maszynami
   - Zlecenia pracy
   - System zgłoszeń

3. **Dashboard i raporty**:
   - Główny dashboard
   - Podstawowe raporty

## 🔧 KONFIGURACJA ŚRODOWISKA

### Pliki konfiguracyjne

- `package.json` - zależności i skrypty
- `prisma/schema.prisma` - schema bazy danych (PostgreSQL)
- `docker-compose.yml` - konfiguracja PostgreSQL (nie używane obecnie)
- `server/index.ts` - główny plik serwera
- `app/page.tsx` - główna strona frontendu

### Porty

- Frontend: 3000
- Backend: 3001
- PostgreSQL: 5432 (gdy będzie działać)

### Skrypty npm

- `npm run dev` - frontend
- `npm run dev:server` - backend
- `npx prisma generate` - generowanie Prisma Client

## 📝 HISTORIA ROZWOJU

### Faza 1: Podstawowa infrastruktura (UKOŃCZONA ✅)

- Utworzono minimalny serwer Fastify
- Dodano CORS
- Dodano podstawowe endpointy
- Przetestowano komunikację frontend-backend

### Faza 2: Baza danych (UKOŃCZONA ✅)

- ✅ PostgreSQL 17 w pełni zainstalowany
- ✅ Hasło użytkownika `postgres`: `8C5c3Aab5`
- ✅ **DATABASE_URL całkowicie rozwiązane** (prawidłowe ładowanie z `database.env`)
- ✅ Migracje Prisma wykonane
- ✅ Baza `litecmms` utworzona z pełną strukturą CMMS

### Faza 3: Integracja i testy (UKOŃCZONA ✅)

- ✅ Połączenie Frontend-Backend-Database w pełni działające
- ✅ Status systemu pokazuje wszystkie komponenty jako "ok"
- ✅ Podstawowa infrastruktura gotowa do rozwoju funkcjonalności

### Faza 4: Wielojęzyczność i UI (UKOŃCZONA ✅)

- ✅ **Usunięte wszystkie hardkodowane teksty** z interfejsu
- ✅ Kompletne tłumaczenia dla 3 języków (PL/EN/DE)
- ✅ Dodane klucze: `descriptions.*`, `systemInfo.*`
- ✅ Działające przełączanie języków bez błędów hydratacji
- ✅ Wszystkie elementy UI używają kluczy tłumaczeń

### Faza 5: System Automatyzacji (UKOŃCZONA ✅)

- ✅ **System automatycznego zarządzania procesami**
- ✅ **Rozwiązanie problemu DATABASE_URL** (całkowita naprawa konfiguracji)
- ✅ Niezawodne skrypty PowerShell bez problemów z kodowaniem
- ✅ Automatyczne rozwiązywanie konfliktów portów
- ✅ Kompletny system testowania i diagnostyki
- ✅ 8 nowych komend npm do zarządzania systemem
- ✅ **Naprawione problemy PowerShell Analyzer** (nieużywane zmienne)
- ✅ **Poprawione testy frontendu** (usunięto konflikt z backendem)
- ⚠️ **Problem z podwójnym uruchamianiem** - czasami skrypty uruchamiają się wielokrotnie

### Faza 6: Naprawa DATABASE_URL i odkrycie autoryzacji (UKOŃCZONA ✅)

- ✅ **Zdiagnozowano problem BOM** w pliku `database.env`
- ✅ **Usunięto BOM** - `dotenv.config()` teraz działa poprawnie
- ✅ **Usunięto hardkodowany fallback** z `server/index.ts`
- ✅ **DATABASE_URL prawidłowo ładowana** z pliku konfiguracyjnego
- ✅ **Odkryto kompletny system autoryzacji**:
  - `server/routes/auth.ts` - endpointy login/register/logout/refresh
  - `server/middleware/auth.ts` - JWT middleware + kontrola ról
  - 5 poziomów ról użytkowników gotowych
  - Bcrypt + JWT + refresh tokeny zaimplementowane
  - **Status**: Napisane ale jeszcze nie zintegrowane z głównym serwerem

### Próby które NIE DZIAŁAŁY ❌

- SQLite - zbyt wiele ograniczeń (brak Json, enum, Decimal)
- Docker - problemy z uruchomieniem Docker Desktop
- **Plik `.env`** - nie istnieje, nie jest używany
- **Plik `database.env`** - istnieje i jest ładowany przez dotenv, ale system używa głównie hardkodowanego fallbacka

## 🎯 METODOLOGIA PRACY

### Wymagania użytkownika

1. **Małe kroki z testami** - każda zmiana musi być testowana
2. **Nie tworzyć mock danych** - tylko prawdziwe rozwiązania
3. **PostgreSQL, nie SQLite** - ustalono definitywnie
4. **Bezpieczeństwo** - wszystko ma być bezpieczne
5. **Cofanie zmian** - gdy coś nie działa, wrócić do ostatniego działającego stanu

### Podejście do problemów

- Gdy coś się komplikuje - STOP i powrót do podstaw
- Testowanie po każdej zmianie
- Jasne komunikowanie co działa, a co nie
- Unikanie chaotycznych zmian
- Nigdy nie zmieniać kodu bez potrzeby, rozwiązuj jeden problem na raz.

### ⚠️ ZASADY KODOWANIA - OBOWIĄZKOWE!

1. **ŻADNEGO HARDKODOWANIA** - wszystkie teksty muszą być w plikach tłumaczeń:
   - ❌ `<p>Zarządzanie maszynami</p>` 
   - ✅ `<p>{t('descriptions.machines')}</p>`
   - Sprawdzaj pliki `locales/*/common.json` przed dodaniem nowych tekstów
   - Dodawaj brakujące klucze do WSZYSTKICH języków (PL/EN/DE)

2. **Wielojęzyczność**:
   - Każdy nowy tekst = nowy klucz w `common.json`
   - Struktura kluczy: `sekcja.element` (np. `descriptions.machines`)
   - Wszystkie 3 języki muszą mieć pełne tłumaczenia

3. **Konsystencja**:
   - Używaj istniejących kluczy zamiast tworzyć nowe
   - Sprawdzaj czy klucz już istnieje przed dodaniem
   - Zachowuj strukturę hierarchiczną kluczy

## 🔧 SYSTEM AUTOMATYZACJI - INSTRUKCJE

### Dostępne komendy npm:

#### Główny system (ZALECANE):

```bash
npm run sys:start    # Uruchom cały system (backend + frontend)
npm run sys:stop     # Zatrzymaj wszystkie procesy
npm run sys:restart  # Restart całego systemu
npm run sys:status   # Sprawdź status wszystkich komponentów
```

#### Komendy backup (stare):

```bash
npm run quick-start  # ⚠️ PROBLEM: używa niestabilnych PowerShell Jobs
npm run stop-all     # ✅ DZIAŁA: zatrzymuje wszystkie procesy
npm run status       # ✅ DZIAŁA: status check (po naprawie emoji)
npm run reset        # ⚠️ MOŻE NIE DZIAŁAĆ: pełny reset
```

### Typowy workflow developmentu:

```bash
# Rano - uruchom system
npm run sys:start

# Sprawdź czy wszystko działa
npm run sys:status

# Podczas pracy - jeśli coś nie gra
npm run sys:restart

# Na koniec dnia
npm run sys:stop
```

### Rozwiązywanie problemów:

```bash
# Problem z systemem
npm run sys:stop
npm run sys:start

# Sprawdź szczegóły
npm run sys:status

# Jeśli nadal problemy - uruchom ręcznie
npm run dev:server  # w jednym terminalu
npm run dev         # w drugim terminalu
```

### ⚠️ WAŻNE ROZWIĄZANIA:

1. **Problem DATABASE_URL**: ✅ **CAŁKOWICIE ROZWIĄZANY** - usunięto BOM, prawidłowe ładowanie z `database.env`
2. **Konflikt portów**: System automatycznie sprawdza i rozwiązuje
3. **Niestabilne procesy**: Nowy system-manager.ps1 jest niezawodny
4. **Kodowanie znaków**: Wszystkie skrypty bez znaków specjalnych
5. **PowerShell Analyzer**: Naprawione ostrzeżenia o nieużywanych zmiennych
6. **Test frontendu**: Poprawiona logika testowania (usunięto konflikt z backendem)
7. **Podwójne uruchamianie**: Problem występuje przy przerwanych komendach

## 🚀 NASTĘPNE KROKI - ROZWÓJ FUNKCJONALNOŚCI

### ✅ INFRASTRUKTURA - W PEŁNI UKOŃCZONA

1. ✅ PostgreSQL 17 działający
2. ✅ Backend Fastify z Prisma 
3. ✅ Frontend Next.js z i18n
4. ✅ Pełne połączenie Frontend-Backend-Database
5. ✅ Migracje i struktura bazy CMMS
6. ✅ **System automatyzacji procesów**
7. ✅ **DATABASE_URL prawidłowo skonfigurowane** (bez hardkodowania)

### Priorytet 1: Integracja gotowego systemu autoryzacji

1. ✅ Model użytkowników w Prisma - GOTOWY
2. ✅ Endpointy rejestracji/logowania - NAPISANE
3. ✅ JWT middleware - NAPISANE
4. ✅ 5 poziomów ról - ZAIMPLEMENTOWANE
5. 🔄 **NASTĘPNE**: Integracja z głównym serwerem:
   - Rejestracja middleware autoryzacji
   - Rejestracja route'ów `/api/auth/*`
   - Konfiguracja JWT i bcrypt w Fastify
   - Testy endpointów autoryzacji

### Priorytet 2: Pierwsze funkcjonalności CMMS

1. Zarządzanie maszynami i urządzeniami
2. System zgłoszeń awarii
3. Zlecenia pracy (Work Orders)
4. Podstawowy kalendarz konserwacji

### Priorytet 3: Dashboard i raporty

1. Główny dashboard z kluczowymi metrykami
2. Podstawowe raporty (awarie, konserwacje)
3. Wykresy i wizualizacje danych

## 🔍 DIAGNOSTYKA

### Sprawdzanie statusu
- Frontend: http://localhost:3000
- Backend: http://localhost:3001/api/system-status
- Health check: http://localhost:3001/health

### Logi
- Backend logi w konsoli (Fastify + nodemon)
- Frontend logi w przeglądarce (React DevTools)

### Typowe problemy
- Port 3001 zajęty - restart serwera
- CORS errors - sprawdzić konfigurację
- Baza danych - sprawdzić połączenie w `/api/system-status`

## 💡 WSKAZÓWKI DLA AI

### Co robić na początku sesji
1. Sprawdź aktualny status systemu
2. Przeczytaj logi z terminala
3. Przetestuj endpointy
4. Zapytaj o aktualny problem

### ⚠️ PROBLEMY ŚRODOWISKA - ZAPAMIĘTAJ!
1. **PowerShell ma problemy z PSReadLine** - błędy konsoli, nie ma co walczyć, używaj prostych komend
2. **Brak pliku `.env`** - backend używa `database.env` + hardkodowany fallback w kodzie
3. **PostgreSQL instalacja jest uszkodzona** - brak plików exe, problemy z usługą
4. **Potrzeba uprawnień administratora** - wiele operacji wymaga "Run as Administrator"

### SPÓJNOŚĆ W DORADZTWIE
- **NIE ZMIENIAJ** podejścia w trakcie sesji (Docker vs lokalnie)
- **PAMIĘTAJ** o wcześniejszych próbach i błędach  
- **DOKUMENTUJ** wszystkie nieudane próby w sekcji "Próby które NIE DZIAŁAŁY"

### ⚠️ PRZED KOŃCEM SESJI - OBOWIĄZKOWE!
**ZAWSZE przed końcem limitu chatu:**

1. **Zaktualizuj AI_CONTEXT.md**:
   - Dodaj nowe osiągnięcia do sekcji "CO DZIAŁA ✅"
   - Zaktualizuj sekcję "CO WYMAGA DOKOŃCZENIA ⚠️"
   - Dodaj nowe problemy/rozwiązania do "HISTORIA ROZWOJU"
   - Zaktualizuj "NASTĘPNE KROKI"

2. **Zaktualizuj README.md** (jeśli potrzeba):
   - Nowe instrukcje instalacji
   - Zmiany w strukturze projektu
   - Nowe endpointy/funkcjonalności

3. **Poinformuj użytkownika**:
   - "🔄 **AKTUALIZUJĘ PLIKI KONTEKSTU** przed końcem sesji"
   - Podsumuj co zostało zrobione
   - Wskaż co trzeba kontynuować w następnej sesji

**Przykład komunikatu:**
> 🔄 **AKTUALIZUJĘ PLIKI KONTEKSTU** przed końcem sesji  
> ✅ **Osiągnięcia**: PostgreSQL zainstalowany, baza połączona  
> ⚠️ **Do kontynuacji**: Pierwsze migracje Prisma  
> 📝 **Pliki zaktualizowane**: AI_CONTEXT.md, README.md

### Czego unikać
- Nie tworzyć nowych plików bez potrzeby
- Nie zmieniać działających części
- Nie proponować SQLite zamiast PostgreSQL
- Nie robić dużych zmian bez testów
- **NIE KOŃCZYĆ SESJI bez aktualizacji kontekstu!**
- **NIGDY nie hardkodować tekstów** - zawsze używać kluczy tłumaczeń
- **NIE TWORZYĆ nowych kluczy** bez sprawdzenia czy już istnieją

### Styl komunikacji
- Zawsze po polsku
- Konkretne kroki z testami
- Jasne oznaczanie co działa (✅) i co nie (❌)
- Emoji dla lepszej czytelności

---

**Ostatnia aktualizacja**: Styczeń 2025 - Faza 6 ukończona  
**Wersja kontekstu**: 1.1  
**Status**: Aktualny - DATABASE_URL naprawiona, system autoryzacji odkryty 